# Backoffice Automation - Deployment Guide

Complete step-by-step instructions for deploying the autonomous development operations center to Fly.io.

## Architecture Overview

- **Platform**: Fly.io single persistent machine
- **Region**: ewr (Secaucus, NJ - closest to Boston)
- **VM Size**: shared-cpu-1x, 1GB RAM
- **Storage**: 10GB persistent volume at `/data`
- **Services**: n8n (port 5678), SSH (port 22 → 10022), Maestro (Electron with Xvfb)

---

## Prerequisites

Before deploying, you must have:

1. **Fly.io account** with CLI installed and authenticated (`fly auth login`)
2. **Claude Code CLI** installed locally (`npm install -g @anthropic-ai/claude-code`)
3. **Max subscription** for Claude Code (for OAuth token)
4. **GitHub account** with access to `teamboswell` org

---

## Phase 1: Generate Authentication Tokens (HUMAN REQUIRED)

### Step 1.1: Generate Claude Code OAuth Token

On your **local machine**, run:

```bash
claude setup-token
```

This will:
- Open a browser for authentication
- Generate an OAuth token
- **Copy and save this token** - you'll need it in Phase 2

### Step 1.2: Create GitHub Personal Access Token

1. Go to https://github.com/settings/tokens
2. Click "Generate new token (classic)"
3. Select scopes:
   - `repo` (full control of private repositories)
   - `workflow` (update GitHub Action workflows)
4. Generate token
5. **Copy and save this token** - you'll need it in Phase 2

---

## Phase 2: Deploy Infrastructure

All files have been generated by AI. Now deploy them to Fly.io.

### Step 2.1: Set Fly Secrets

**CRITICAL**: Secrets must be set BEFORE first deploy.

```bash
# From project root directory
fly secrets set CLAUDE_CODE_OAUTH_TOKEN=<your-oauth-token-from-step-1.1> -a backoffice-automation
fly secrets set GH_TOKEN=<your-github-pat-from-step-1.2> -a backoffice-automation
```

Verify secrets are set:

```bash
fly secrets list -a backoffice-automation
```

**Note**: n8n owner account cannot be pre-configured via environment variables. You will create it securely via fly proxy in Phase 3.

### Step 2.2: Deploy to Fly.io

```bash
fly deploy -a backoffice-automation
```

This will:
- Build the Docker image (takes 5-10 minutes first time)
- Deploy to Fly.io
- Mount the persistent volume
- Start all services (n8n, Maestro, SSH)

### Step 2.3: Verify Deployment

```bash
# Check machine status
fly status -a backoffice-automation

# Watch logs
fly logs -a backoffice-automation

# Expected log output:
# - "Starting Xvfb on display :99..."
# - "Starting SSH server..."
# - "Starting n8n on port 5678..."
# - "Starting Maestro..."
# - "All services started"
```

---

## Phase 3: Initial Setup (HUMAN REQUIRED)

### Step 3.1: n8n First-Time Setup (via Secure Tunnel)

**IMPORTANT**: The app is NOT publicly accessible yet. You must use fly proxy for secure first-time setup.

1. Create secure tunnel from your local machine:
   ```bash
   fly proxy 5678:5678 -a backoffice-automation
   ```

2. Open browser to: http://localhost:5678

3. Complete n8n setup wizard:
   - Create owner account: brandon.casci@gmail.com
   - Set strong password (at least 8 chars, 1 number, 1 capital)
   - Set instance name (e.g., "Backoffice Automation")

4. After setup is complete, verify you can log in

5. **Enable public access** (see Step 3.1.1 below)

### Step 3.1.1: Enable Public Access (After Setup Complete)

Once owner account is created, enable public HTTPS access:

1. Edit `fly.toml` - uncomment the `[http_service]` section:
   ```toml
   [http_service]
     internal_port = 5678
     force_https = true
     auto_stop_machines = 'off'
     auto_start_machines = true
     min_machines_running = 1
     processes = ['app']
   ```

2. Redeploy:
   ```bash
   fly deploy -a backoffice-automation
   ```

3. Verify public access: https://backoffice-automation.fly.dev
   - Should show login page (not setup wizard)
   - Log in with your owner account

### Step 3.2: Install n8n Community Node

**IMPORTANT**: This must be done via n8n UI, cannot be pre-installed.

1. In n8n, go to: **Settings → Community Nodes**
2. Click **Install a community node**
3. Enter: `@johnlindquist/n8n-nodes-claudecode`
4. Click **Install**
5. Restart n8n if prompted (via Fly: `fly apps restart backoffice-automation`)

### Step 3.3: Configure n8n Credentials

Set up GitHub authentication:

1. Go to: **Credentials → Add Credential → GitHub**
2. Select **Access Token** method
3. Enter your `GH_TOKEN` (same as Fly secret)
4. Test connection
5. Save as "GitHub Personal"

Optional credentials (if using those workflows):
- Email (IMAP/SMTP)
- Slack Bot Token
- Sentry API Token

### Step 3.4: Import Workflows

1. Go to: **Workflows → Import from File**
2. Import each JSON file from `/workflows/`:
   - `github-auto-implementation.json`
   - `daily-digest.json`
3. For each workflow:
   - Update credential references
   - Update repository names if different
   - Activate the workflow

---

## Phase 4: Post-Deploy Setup (AUTOMATED VIA SSH)

### Step 4.1: Run Post-Deploy Script

SSH into the machine:

```bash
fly ssh console -a backoffice-automation
```

Run the setup script:

```bash
bash /scripts/post-deploy-setup.sh
```

This script will:
- ✓ Verify Claude Code and GitHub authentication
- ✓ Clone `teamboswell/boswell-hub` and `teamboswell/boswell-app` to `/data/repos/`
- ✓ Install CCPM in each repository
- ✓ Initialize CCPM (`/pm:init`, `/context:create`)
- ✓ Copy custom skills to each repository

Expected output:

```
=========================================
Post-Deploy Setup Complete!
=========================================
```

### Step 4.2: Verify Setup

While still in SSH session:

```bash
# Test Claude Code
claude -p "echo 'test'"

# Test GitHub CLI
gh repo list teamboswell

# Check repos
ls -la /data/repos/
# Should see: boswell-hub/ and boswell-app/

# Check CCPM
cd /data/repos/boswell-hub
claude -p "/pm:help"
```

Exit SSH: `exit`

---

## Phase 5: Maestro Configuration (OPTIONAL)

### Step 5.1: Access Maestro Remotely

Maestro runs on the machine with a web UI. To access it remotely:

**Option A: Cloudflare Quick Tunnel (Temporary)**

SSH into machine:

```bash
fly ssh console -a backoffice-automation
```

Find Maestro's port (check logs or config), then:

```bash
cloudflared tunnel --url http://localhost:<maestro-port>
```

This gives you a temporary public URL.

**Option B: Cloudflare Named Tunnel (Persistent)**

See Cloudflare Tunnel documentation: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/

**Option C: SSH Tunnel**

From your local machine:

```bash
fly proxy <local-port>:<maestro-remote-port> -a backoffice-automation
```

Then access at `http://localhost:<local-port>`

### Step 5.2: Configure Maestro Agents

In Maestro UI:
1. Create agents pointing to `/data/repos/boswell-hub` and `/data/repos/boswell-app`
2. Import playbooks from `/playbooks/`
3. Test a simple playbook execution

---

## Monitoring & Access

| What         | How                                                  |
| ------------ | ---------------------------------------------------- |
| n8n UI       | https://backoffice-automation.fly.dev                |
| SSH          | `fly ssh console -a backoffice-automation`           |
| Logs         | `fly logs -a backoffice-automation`                  |
| Status       | `fly status -a backoffice-automation`                |
| Maestro UI   | Via Cloudflare tunnel or SSH tunnel                  |
| Volume       | `fly volumes list -a backoffice-automation`          |

---

## Troubleshooting

### Issue: n8n not accessible

```bash
# Check if service is running
fly ssh console -a backoffice-automation
ps aux | grep n8n

# Check logs
fly logs -a backoffice-automation | grep n8n

# Restart app
fly apps restart backoffice-automation
```

### Issue: Claude Code authentication fails

```bash
# SSH into machine
fly ssh console -a backoffice-automation

# Check if token is set
env | grep CLAUDE_CODE_OAUTH_TOKEN
# Should show: CLAUDE_CODE_OAUTH_TOKEN=********

# Test auth
claude -p "echo test"

# If fails, regenerate token locally and update secret:
# On local machine: claude setup-token
# Then: fly secrets set CLAUDE_CODE_OAUTH_TOKEN=<new-token> -a backoffice-automation
# Then: fly apps restart backoffice-automation
```

### Issue: GitHub CLI authentication fails

```bash
# SSH into machine
fly ssh console -a backoffice-automation

# Check token
env | grep GH_TOKEN

# Test auth
gh auth status

# If fails, update secret:
# fly secrets set GH_TOKEN=<new-token> -a backoffice-automation
# fly apps restart backoffice-automation
```

### Issue: Maestro not starting

```bash
# Check if Xvfb is running
ps aux | grep Xvfb

# Check Maestro logs
fly logs -a backoffice-automation | grep -i maestro

# Maestro may fail on headless Linux - this is expected
# Fallback: Use direct `claude -p` commands from n8n instead
```

### Issue: Volume full

```bash
# Check volume usage
fly ssh console -a backoffice-automation
df -h /data

# If full, resize volume (can only increase):
fly volumes extend backoffice_data -s 20 -a backoffice-automation
```

---

## Cost Estimate

| Item                                     | Monthly Cost |
| ---------------------------------------- | ------------ |
| Fly.io shared-cpu-1x + 10GB volume       | ~$15-20      |
| Claude Code (Max subscription)           | $0 (included)|
| n8n, Maestro, CCPM (open source)         | $0           |
| **Total**                                | **~$15-20**  |

*Note: Costs may vary. Check Fly.io pricing for latest rates.*

---

## Next Steps

1. **Test the system**:
   - Create a test GitHub issue labeled "auto"
   - Verify n8n webhook triggers
   - Check if Maestro executes playbook

2. **Configure webhooks**:
   - GitHub: Repository Settings → Webhooks
   - Point to: `https://backoffice-automation.fly.dev/webhook/github-auto`
   - Events: Issues, Pull requests

3. **Set up Sentry integration** (optional):
   - Add Sentry webhook to n8n
   - Configure error → issue workflow

4. **Monitor and iterate**:
   - Watch logs for errors
   - Refine playbooks based on results
   - Add more workflows as needed

---

## Security Notes

- OAuth token and GitHub PAT are stored as Fly secrets (encrypted at rest)
- Never log or expose these tokens in application code
- SSH access is key-based only (no password auth)
- n8n requires authentication (set during first-time setup)
- Volume snapshots are enabled by default (5-day retention)

---

## Maintenance

### Updating Dependencies

SSH in and run:

```bash
npm update -g n8n @anthropic-ai/claude-code
```

### Updating Maestro

1. Download new AppImage from GitHub releases
2. SSH in and replace in `/usr/local/bin/`
3. Restart app

### Backup

Fly automatically snapshots volumes daily (5-day retention). To create manual snapshot:

```bash
fly volumes snapshots list backoffice_data -a backoffice-automation
fly volumes snapshots create backoffice_data -a backoffice-automation
```

---

## Support

- **Fly.io Docs**: https://fly.io/docs/
- **n8n Docs**: https://docs.n8n.io/
- **Maestro Docs**: https://docs.runmaestro.ai/
- **CCPM Docs**: https://github.com/automazeio/ccpm
- **Claude Code Docs**: https://code.claude.com/docs/

---

**Deployment Date**: 2026-02-10
**Spec Version**: v1.0
**Region**: ewr (Secaucus, NJ)
